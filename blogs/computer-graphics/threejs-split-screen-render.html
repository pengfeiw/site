<html lang="zh_cn"><head><title>Threejs 分屏绘制 | 王鹏飞</title><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="viewport,scissor,compute graphics,CG,WebGL,OpengGL,ThreeJS,分屏渲染,SplitScreen"><meta name="description" content="使用 Threejs 进行分屏渲染场景，讲述 viewport 和 scissor 的区别和作用。"><link rel="stylesheet" href="/blogs/assests/code_github.css"><link rel="stylesheet" href="/blogs/assests/github_markdown.css"><link rel="stylesheet" href="/blogs/assests/article.css"><link rel="stylesheet" href="/blogs/assests/navigator.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous"><link rel="icon" href="/blogs/assests/images/icon.jpg"><meta property="author" content="王鹏飞"><script type="text/javascript">window.addEventListener("DOMContentLoaded",function(){document.getElementById("search-input").addEventListener("search",e=>{e.target.value&&window.open(`https://bing.com/search?q=${e.target.value}%20site%3A+pengfeixc.com`,"_blank")})})</script></head><body><div class="header"><div class="navigator"><div class="links"><div class="home"><a href="/blogs">Home</a></div><div class="email"><a href="mailto:pengfeixc@sina.com">Email</a></div><div class="github"><a target="_blank" href="https://github.com/pengfeiw">GitHub</a></div><div clss="minicode"><a target="_blank" href="https://pengfeiw.github.io/minicode">MiniCode</a></div><div class="search"><input id="search-input" type="search" placeholder="search"></div><div class="rss"><a href="/blogs/rss.xml"><img src="/blogs/assests/images/rss.svg" alt="rss"></a></div></div></div></div><div class="body"><div class="nothing"></div><div class="markdown"><div class="markdown-header"><span class="date">日期：2021年12月9日</span><span class="category"><a href="/blogs/computer-graphics">标签：ComputerGraphics</a></span></div><div class="markdown-body"><h1 id="Threejs 分屏绘制">Threejs 分屏绘制 <a href="#Threejs 分屏绘制">#</a></h1><p>做三维渲染时，偶尔会有分屏绘制的需求，将从不同角度观察到的场景绘制到屏幕上，类似下面这种。</p><p><img src="https://pengfeiw.github.io/assests/blog-image/013.jpg" alt="threejs 分屏绘制"></p><p>某些本地双人游戏，也是利用了这种分屏机制，例如<a href="https://www.ea.com/games/it-takes-two?isLocalized=true">《双人成行》</a>、<a href="https://www.ign.com.cn/overcooked-2">《胡闹厨房》</a>（在这里，特别向大家推荐《双人成行》这款游戏，真的非常棒）。</p><p>本篇文章，讲解如何使用 Threejs 进行分屏绘制。</p><p>讲解 Threejs 分屏绘制之前，先了解下 CS 中的两个概念 viewport 和 scissor。</p><h2 id="一. viewport 和 scissor">一. viewport 和 scissor <a href="#一. viewport 和 scissor">#</a></h2><p>viewport，中文意，即视口、视窗的意思，scissor 是用剪刀剪、剪刀的意思。</p><p>关于viewport的详细解释，可以看<a href="https://docs.microsoft.com/en-au/windows/win32/direct3d9/viewports-and-clipping?redirectedfrom=MSDN">这里</a>。简答的说viewport就是摄像机观察到的空间（可以绘制到屏幕上的区域）。</p><p>scissor 就是裁剪的意思，可以将 viewport 进行裁剪，绘制 viewport 其中的一块区域，我在 <a href="https://gamedev.stackexchange.com/a/167051">StackExchange</a> 上找到一个关于 viewport 和 scissor 很形象的解释，作者用图片很形象的解释了 viewport、scissor 和窗口大小之间的关系，分为四种不同情况。</p><p>在 opengl(webGL) 中裁剪空间的范围是 -1 ~ + 1的。</p><p><img src="https://pengfeiw.github.io/assests/blog-image/014.jpg" alt="裁剪空间的X、Y坐标范围"></p><p>然后，裁剪空间内的图像需要映射到屏幕窗口坐标系。</p><p>想像一下，我们的窗口是黑色的背景，在绘制之前使用白色去清除颜色（openGL 中使用 glClearColor 指定清屏颜色)。</p><ol><li>一般情况下，我们使 viewport 和 scissor 覆盖到整个窗口区域。</li></ol><p><img src="https://pengfeiw.github.io/assests/blog-image/015.jpg" alt="viewport 与 scissor 覆盖到全部窗口区域"></p><ol start="2"><li>有时候，我们想将图像绘制到屏幕的某一个区域，此时只需要将viewport设置为某个子区域。</li></ol><p><img src="https://pengfeiw.github.io/assests/blog-image/016.jpg" alt="viewport 与 scissor 覆盖到窗口区域的子区域"></p><ol start="3"><li>scissor 也可以取 viewport 的一个子区域。</li></ol><p><img src="https://pengfeiw.github.io/assests/blog-image/017.jpg" alt="scissor 也可以取 viewport 的一个子区域"></p><ol start="4"><li>最后 scissor 也可以比 viewport 范围更大，例如 scissor 覆盖到整个屏幕，但是 viewport 取某个子区域。</li></ol><p><img src="https://pengfeiw.github.io/assests/blog-image/018.jpg" alt="scissor 覆盖到整个屏幕, viewport 取屏幕的某一块区域"></p><p>注意到此时，viewport是一个较小的区域，但是 <code>glClear</code> 影响的却是整个屏幕，因为 <code>glClear</code> 的范围由 scissor 的范围决定。</p><p>理解了 viewport 和 scissor，接下来我们使用 Threejs 进行分屏绘制。</p><h2 id="二. 分屏绘制">二. 分屏绘制 <a href="#二. 分屏绘制">#</a></h2><blockquote><p>需要完整的代码，请戳<a href="https://github.com/pengfeiw/threejs-split-render/tree/main">这里</a>。</p></blockquote><p>看一下效果，点击<a href="https://pengfeiw.github.io/threejs-split-render/">这里</a>大屏查看。</p><iframe src="https://pengfeiw.github.io/threejs-split-render/"></iframe><p>在例子中，使用了两个不同位置的相机，然后利用WebGLRenderer分屏渲染这两个相机。</p><pre><code class="hljs language-typescript">    renderer.<span class="hljs-title function_">setScissorTest</span>(<span class="hljs-literal">true</span>); <span class="hljs-comment">// enable scissor test</span>

    <span class="hljs-comment">// view1</span>
    scene.<span class="hljs-property">background</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-string">"black"</span>);
    
    renderer.<span class="hljs-title function_">setViewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, halfW, container.<span class="hljs-property">clientHeight</span>);
    renderer.<span class="hljs-title function_">setScissor</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, halfW, container.<span class="hljs-property">clientHeight</span>);

    renderer.<span class="hljs-title function_">render</span>(scene, camera1);

    <span class="hljs-comment">// view2</span>
    scene.<span class="hljs-property">background</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-string">"gray"</span>);

    renderer.<span class="hljs-title function_">setViewport</span>(halfW, <span class="hljs-number">0</span>, container.<span class="hljs-property">clientWidth</span> / <span class="hljs-number">2</span>, container.<span class="hljs-property">clientHeight</span>);
    renderer.<span class="hljs-title function_">setScissor</span>(halfW, <span class="hljs-number">0</span>, container.<span class="hljs-property">clientWidth</span> / <span class="hljs-number">2</span>, container.<span class="hljs-property">clientHeight</span>);

    renderer.<span class="hljs-title function_">render</span>(scene, camera2);
</code></pre><p>首先需要通过 <code>renderer.setScissorTest(true)</code> 开启 scissor test，然后使用 <code>renderer.setViewport</code> 和 <code>renderer.setScissor</code>分别设置 viewport 和 scissor 的位置，这样就可以进行分屏渲染。</p><p>（完）</p></div><div class="markdown-footer"><span class="pre-article"><a href="/blogs/developer-handbook/study-dot-pixel-dpi-ppi-in-ten-minutes">上一篇：十分钟了解Dot、Pixel、DPI、PPI</a></span><span class="next-article"><a href="/blogs/minicode/threejs-rubik">下一篇：Threejs 实现任意阶级的魔方</a></span></div></div><div class="toc"><div class="toc-header">目录</div><div class="toc-body"><div class="toc-item"><a class="toc-item-link" href="#Threejs 分屏绘制" style="padding-left:15px">Threejs 分屏绘制</a></div><div class="toc-item"><a class="toc-item-link" href="#一. viewport 和 scissor" style="padding-left:30px">一. viewport 和 scissor</a></div><div class="toc-item"><a class="toc-item-link" href="#二. 分屏绘制" style="padding-left:30px">二. 分屏绘制</a></div></div></div></div></body></html>