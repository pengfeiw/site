<html lang="zh_cn"><head><title>useEffect和useLayoutEffect的区别 | 王鹏飞</title><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords"><meta name="description" content="了解useEffect和useLayoutEffect的执行过程，知道什么时候该用useEffect，什么时候应该用useLayoutEffect。"><link rel="stylesheet" href="/blogs/assests/code_github.css"><link rel="stylesheet" href="/blogs/assests/github_markdown.css"><link rel="stylesheet" href="/blogs/assests/article.css"><link rel="stylesheet" href="/blogs/assests/navigator.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous"><link rel="icon" href="/blogs/assests/images/icon.jpg"><meta property="author" content="王鹏飞"><script type="text/javascript">window.addEventListener("DOMContentLoaded",function(){document.getElementById("search-input").addEventListener("search",e=>{e.target.value&&window.open(`https://bing.com/search?q=${e.target.value}%20site%3A+pengfeixc.com`,"_blank")})})</script></head><body><div class="header"><div class="navigator"><div class="links"><div class="home"><a href="/blogs">Home</a></div><div class="email"><a href="mailto:pengfeixc@sina.com">Email</a></div><div class="github"><a target="_blank" href="https://github.com/pengfeiw">GitHub</a></div><div clss="minicode"><a target="_blank" href="https://pengfeiw.github.io/minicode">MiniCode</a></div><div class="search"><input id="search-input" type="search" placeholder="search"></div><div class="rss"><a href="/blogs/rss.xml"><img src="/blogs/assests/images/rss.svg" alt="rss"></a></div></div></div></div><div class="body"><div class="nothing"></div><div class="markdown"><div class="markdown-header"><span class="date">日期：2021年3月24日</span><span class="category"><a href="/blogs/react">标签：React</a></span></div><div class="markdown-body"><h1 id="useEffect和useLayoutEffect的区别">useEffect和useLayoutEffect的区别 <a href="#useEffect和useLayoutEffect的区别">#</a></h1><h3 id="一.useEffect和useLayoutEffect的执行过程">一.useEffect和useLayoutEffect的执行过程 <a href="#一.useEffect和useLayoutEffect的执行过程">#</a></h3><p>首先要说明的是，useLayoutEffect和useEffect很像，函数签名也是一样。唯一的不同点就是<strong>useEffect是异步执行，而useLayoutEffect是同步执行</strong>的。 当函数组件刷新（渲染）时，包含useEffect的组件整个运行过程如下：</p><ol><li><p>触发组件重新渲染（通过改变组件state或者组件的父组件重新渲染，导致子节点渲染）。</p></li><li><p>组件函数执行。</p></li><li><p>组件渲染后呈现到屏幕上。</p></li><li><p><code>useEffect</code> hook执行。</p></li></ol><p>当函数组件刷新（渲染）时，包含useLayoutEffect的组件整个运行过程如下：</p><ol><li><p>触发组件重新渲染（通过改变组件state或者组件的父组件重新渲染，导致子组件渲染）。</p></li><li><p>组件函数执行。</p></li><li><p><code>useLayoutEffect</code> hook执行, React等待useLayoutEffect的函数执行完毕。</p></li><li><p>组件渲染后呈现到屏幕上。</p></li></ol><p>useEffect异步执行的优点是，react渲染组件不必等待useEffect函数执行完毕，造成阻塞。</p><p><strong>百分之99的情况，使用useEffect就可以了，唯一需要用到useLayoutEffect的情况就是，在使用useEffect的情况下，我们的屏幕会出现闪烁的情况（组件在很短的时间内渲染了两次）。</strong></p><p>例如，下面的代码，组件就会渲染两次。</p><pre><code class="hljs language-tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDom</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react-dom"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, {useEffect, useLayoutEffect, useState} <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"></span>) =&gt; {
    <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (value === <span class="hljs-number">0</span>) {
            <span class="hljs-title function_">setValue</span>(<span class="hljs-number">10</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">200</span>);
        }
    }, [value]);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"render"</span>, value);
    <span class="hljs-keyword">return</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setValue(0)}&gt;
            value: {value}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
};
<span class="hljs-title class_">ReactDom</span>.<span class="hljs-title function_">render</span>(
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>,
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"root"</span>)
);
</code></pre><p>上面的代码，如果使用useEffect，当你点击div时，会出现短暂的闪烁，屏幕上会先出现0，然后出现useEffect中设定的数字，但是使用useLayoutEffect则不会出现闪烁的情况。</p><h3 id="二.使用useRef获得组件前一个状态">二.使用useRef获得组件前一个状态 <a href="#二.使用useRef获得组件前一个状态">#</a></h3><p>了解了useEffect的执行过程，我们可以通过useRef获得组件上一个状态的state和props，请看下面的例子：</p><pre><code class="hljs language-tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> prevCountRef = useRef&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">1</span>); <span class="hljs-comment">// 组件前一个状态</span>
    <span class="hljs-comment">// useEffect会在组件函数执行后，在执行</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        prevCountRef.<span class="hljs-property">current</span> = count;
    });
    
    <span class="hljs-comment">// 这一句会在useEffect函数执行前执行</span>
    <span class="hljs-keyword">const</span> prevCount = prevCountRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">return</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Now: {count}, before: {prevCount}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count =&gt; count + 1)}&gt;click<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre><p>因为useEffect会在组件函数执行之后执行，所以preCountRef会存储之前的值。</p><p>(完)</p></div><div class="markdown-footer"><span class="pre-article"><a href="/blogs/react/react-ref">上一篇：组件通信之ref</a></span><span class="next-article"><a href="/blogs/javascript/valueOf-and-toString">下一篇：valueOf和toString方法</a></span></div></div><div class="toc"><div class="toc-header">目录</div><div class="toc-body"><div class="toc-item"><a class="toc-item-link" href="#useEffect和useLayoutEffect的区别" style="padding-left:15px">useEffect和useLayoutEffect的区别</a></div><div class="toc-item"><a class="toc-item-link" href="#一.useEffect和useLayoutEffect的执行过程" style="padding-left:45px">一.useEffect和useLayoutEffect的执行过程</a></div><div class="toc-item"><a class="toc-item-link" href="#二.使用useRef获得组件前一个状态" style="padding-left:45px">二.使用useRef获得组件前一个状态</a></div></div></div></div></body></html>