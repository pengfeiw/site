<html lang="zh_cn"><head><title>Yarn Workspace</title><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="yarn workspace,workspace,yarn,monorepo"><meta name="description" content="如何使用 yarn workspace 管理复杂项目，多 package 项目"><link rel="stylesheet" href="/blogs/assests/code_github.css"><link rel="stylesheet" href="/blogs/assests/github_markdown.css"><link rel="stylesheet" href="/blogs/assests/article.css"><link rel="stylesheet" href="/blogs/assests/navigator.css"><link rel="icon" href="/blogs/assests/images/icon.jpg"><meta property="author" content="王鹏飞"><script type="text/javascript">window.addEventListener("DOMContentLoaded",function(){document.getElementById("search-input").addEventListener("search",e=>{e.target.value&&window.open(`https://bing.com/search?q=${e.target.value}%20site%3A+pengfeixc.com`,"_blank")})})</script></head><body><div class="header"><div class="navigator"><div class="links"><div class="email"><a href="mailto:pengfeixc@sina.com">Email</a></div><div class="github"><a target="_blank" href="https://github.com/pengfeiw">GitHub</a></div><div clss="minicode"><a target="_blank" href="https://pengfeiw.github.io/minicode">MiniCode</a></div><div class="search"><input id="search-input" type="search" placeholder="search"></div><div class="rss"><a href="/blogs/rss.xml"><img src="/blogs/assests/images/rss.png" alt="rss"></a></div></div></div><a href="/blogs/"><img src="/blogs/assests/images/icon.jpg"></a></div><div class="markdown"><div class="markdown-header"><span class="date">日期：2022年11月12日</span><span class="category"><a href="/blogs/javascript">标签：JavaScript</a></span></div><div class="markdown-body"><h1 id="Yarn Workspace">Yarn Workspace <a href="#Yarn Workspace">#</a></h1><p>每当你准备写一个新项目的时候，你有没有想过是否需要将前后端代码用不同的 git 仓库进行管理，又或者是否需要将一些相对底层的代码拆分成一个单独的 git 仓库，以便于后面等底层代码稳定的时候，可以直接发布为一个独立的 npm package 供项目使用。</p><p>那么这样不是可以直接用不同的 git 仓库进行管理么。的确可以这样，但是如果不同的项目在不同的 git 仓库时，每当我要在另一个项目中查找一些代码的时候，就显得不是特别方便，所以我希望所有相关的 package 能在一个 git 仓库中。</p><p>以前我经常会在这件事上纠结，也为此查找了很多资料。今天记录下我常用的一种管理代码的方式——yarn workspace。</p><h2 id="yarn workspace 是什么？">yarn workspace 是什么？ <a href="#yarn workspace 是什么？">#</a></h2><p>yarn workspace 可以让一个单独的 git 仓库包含多个 package。例如你有一个 front-end 项目和一个 back-end 项目，那么你可以通过 yarn workspace 同时管理这两个 package，package 之间是相互独立的，即使脱离了主仓库也可以是一个完整独立的项目。</p><p><a href="https://github.com/facebook/react/tree/master/packages">React</a> 就使用了 yarn workspace 机制。</p><h2 id="实践">实践 <a href="#实践">#</a></h2><ol><li>创建项目文件</li></ol><p>新建文件夹 <code>example-monorepo</code>:</p><pre><code class="hljs language-bash">$ <span class="hljs-built_in">mkdir</span> example-monorepo
</code></pre><p>在 <code>example-monorepo</code> 文件夹中创建 <code>package.json</code>:</p><pre><code class="hljs language-bash">$ <span class="hljs-built_in">cd</span> example-monorepo
$ <span class="hljs-built_in">touch</span> package.json
</code></pre><p>在 <code>package.json</code> 中输入以下内容：</p><pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
   <span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"example-monorepo"</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"workspaces"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre><ol start="2"><li>创建一个 react 项目并添加至 workspace list</li></ol><p>在项目中创建 packages 文件夹，用于存储不同的子项目。</p><pre><code class="hljs language-bash">$ <span class="hljs-built_in">mkdir</span> packages
</code></pre><p>创建 react 项目：</p><pre><code class="hljs language-bash">$ yarn create-react-app packages/client
</code></pre><p>告诉 Yarn 将 <code>client</code> 以 workspace 处理。我们只需要将 <code>client</code> 添加至 package.json 文件里的 <code>workspaces</code> 列表中。</p><pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
   <span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"example-monorepo"</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"workspaces"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"client"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre><ol start="3"><li>创建一个 express 项目，并添加至 workspace list 中</li></ol><p>创建了前端项目后，我们再创建一个 express 后端项目，首先安装 <code>express-generator</code>。</p><pre><code class="hljs language-bash">$ yarn global add express-generator --prefix /usr/local
</code></pre><p>使用 <code>express-generator</code> 创建 express 项目。</p><pre><code class="hljs language-bash">$ express --view=pug packages/server
</code></pre><p>同样将 <code>server</code> 添加至 workspace 中。</p><pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
   <span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"example-monorepo"</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"workspaces"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"client"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"server"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre><ol start="4"><li>安装依赖</li></ol><p>安装运行所需的依赖，我们只需要在项目的根目录下执行 <code>yarn install</code> 命令，yarn 会自动为所有的 package 安装依赖。</p><pre><code class="hljs language-bash">$ yarn install
</code></pre><p>这个命令会生成一个 <code>yarn.lock</code> 文件，包含项目运行所有的依赖信息，这个文件是自动生成的，一般不要手动修改它。</p><ol start="5"><li>使用（*）导入所有的 package</li></ol><p>workspace 支持 <code>*</code> 可以匹配任意名称的 package。所以可以将 workspace 改为：</p><pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
   <span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"example-monorepo"</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"workspaces"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"packages/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre><ol start="6"><li>运行所有 package</li></ol><p>使用 <a href="https://www.npmjs.com/package/concurrently">concurrently</a> 并行运行多个脚本命令。</p><pre><code class="hljs language-bash">yarn add -W concurrently
</code></pre><p>将 package.json 改为：</p><pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
   <span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"example-monorepo"</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"workspaces"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"packages/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
       <span class="hljs-attr">"client"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yarn workspace client start"</span><span class="hljs-punctuation">,</span>
       <span class="hljs-attr">"server"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yarn workspace server start"</span><span class="hljs-punctuation">,</span>
       <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"concurrently --kill-others-on-fail \"yarn server\"  \"yarn client\"
   }
}</span>
</code></pre><p>通过 <code>yarn workspace &lt;package&gt; &lt;script&gt;</code> 可以执行 package 中的命令。</p><p>最后运行项目：</p><pre><code class="hljs language-bash">$ yarn start
</code></pre><p>（完）</p></div><div class="markdown-footer"><span class="pre-article"><a href="/blogs/developer-handbook/pipelines-in-shell">上一篇：Pipelines in Shell</a></span><span class="next-article"><a href="/blogs/javascript/rollup-with-typescript">下一篇：使用 rollup 和 typescript 配置项目</a></span></div></div></body></html>