<html lang="zh_cn"><head><title>初次使用 Github 的 SSH deployKey | 王鹏飞</title><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="SSH DeployKey,CI/CD,Github Actions,Github"><meta name="description" content="如何使用 SSh DeployKey 配合 Github Actions，push 代码时，自动 push 文件到另一个仓库"><link rel="stylesheet" href="/blogs/assests/code_github.css"><link rel="stylesheet" href="/blogs/assests/github_markdown.css"><link rel="stylesheet" href="/blogs/assests/article.css"><link rel="stylesheet" href="/blogs/assests/navigator.css"><link rel="icon" href="/blogs/assests/images/icon.jpg"><meta property="author" content="王鹏飞"><script type="text/javascript">window.addEventListener("DOMContentLoaded",function(){document.getElementById("search-input").addEventListener("search",e=>{e.target.value&&window.open(`https://bing.com/search?q=${e.target.value}%20site%3A+pengfeixc.com`,"_blank")})})</script></head><body><div class="header"><div class="navigator"><div class="links"><div class="home"><a href="`${root}`">Home</a></div><div class="email"><a href="mailto:pengfeixc@sina.com">Email</a></div><div class="github"><a target="_blank" href="https://github.com/pengfeiw">GitHub</a></div><div clss="minicode"><a target="_blank" href="https://pengfeiw.github.io/minicode">MiniCode</a></div><div class="search"><input id="search-input" type="search" placeholder="search"></div><div class="rss"><a href="/blogs/rss.xml"><img src="/blogs/assests/images/rss.svg" alt="rss"></a></div></div></div></div><div class="markdown"><div class="markdown-header"><span class="date">日期：2023年8月27日</span><span class="category"><a href="/blogs/developer-handbook">标签：Developer</a></span></div><div class="markdown-body"><h1 id="初次使用 Github 的 SSH DeployKey">初次使用 Github 的 SSH DeployKey <a href="#初次使用 Github 的 SSH DeployKey">#</a></h1><p>最近重构了下网站，把网站从腾讯云移到了 Github，在 Github 上，通过 <a href="https://docs.github.com/en/actions">Github Actions</a> 实现网站的自动部署。</p><p>我重新写了个网站生成器（site-generator），能将指定文件夹下的 markdown 文件转换为静态的 html 文件。</p><p><img src="../static/images/1.png" alt="将 markdown 转化为 html 页面"></p><p>然后将生成的 html 页面部署到 <a href="https://docs.github.com/en/pages/getting-started-with-github-pages">Github Page</a> 中 即可。</p><h2 id="用 Github Actions 实现自动部署">用 Github Actions 实现自动部署 <a href="#用 Github Actions 实现自动部署">#</a></h2><p>使用 Github Actions 可以自动化这一过程。通过 Github Actions 你可以在对 Github 特定 repo 做出某个更新时，自动执行一些特定的任务，例如我想在 site-generator 仓库中的 main 分支提交了代码时，Github 能为我自动执行打包部署命令。</p><p>我可以这么做，达到我的目的，首先创建 <code>.github/deploy.yml</code>：</p><pre><code class="hljs language-yml"><span class="hljs-attr">name:</span> <span class="hljs-string">deploy</span>
<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">main</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">deploy-to-github-page:</span>
    <span class="hljs-comment"># 指定 Github Action 运行环境</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
    <span class="hljs-comment"># 执行 step：安装依赖</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">i</span> <span class="hljs-comment"># 要执行的命令</span>
    <span class="hljs-comment"># 执行 step: 打包和部署</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">And</span> <span class="hljs-string">Deploy</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span> <span class="hljs-comment"># 需要执行的多行命令</span>
          <span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">build</span>
          <span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">deploy</span>
</code></pre><p>将 <code>.github/deploy.yml</code> 提交到 github repo 后，github action 会自动执行。Github Action 具体细节这里不做赘述，感兴趣的可以阅读官方文档。</p><h2 id="在 Github Action 中将文件 push 到另一个仓库">在 Github Action 中将文件 push 到另一个仓库 <a href="#在 Github Action 中将文件 push 到另一个仓库">#</a></h2><p>我想在 Github Action 中做以下几件事：</p><pre><code>1. 用 site-generator 将 markdown 文件转换成静态 html 页面
2. 将生成的 html 页面 push 到 site 仓库，site 仓库开启了 Github Pages 功能，可以通过浏览器访问
</code></pre><p>但是我在做第二件事时，遇到了困难，当我执行 <code>git push</code> 命令时，Action 报错了，提示我没有权限，无法访问（unable to access...）。</p><h2 id="使用 SSH Depolykey 解决问题">使用 SSH Depolykey 解决问题 <a href="#使用 SSH Depolykey 解决问题">#</a></h2><p>查阅了一些资料，终于找到了解决问题的方式。</p><ol><li>生成 SSH Key 文件</li></ol><pre><code class="hljs language-bash">$ ssh-keygen -t ed25519 -C <span class="hljs-string">"your_email@example.com"</span>
</code></pre><p><code>-t ed25519</code> 是 github 官方推荐使用的选项。</p><p><code>ssh-keygen</code> 命令会提示生成密钥文件的路径名称，建议取一个比较容易记得名称，例如 <code>id_github_repo_site</code>。</p><p>命令结束后会生成两个文件私钥 <code>id_github_repo_site</code> 和公钥 <code>id_github_repo_site.pub</code>。</p><ol start="2"><li>将私钥和公钥添加到 github repo 中</li></ol><p>我需要在 site-generator 仓库中将文件 push 到 site 仓库中，那么我需要把公钥添加到 site 仓库中（即目标仓库），将私钥添加到 site-generator 仓库中。</p><p>在 site-generator 仓库的 settings 面板中找到 Secrets and variables/Actions，然后添加一个 KEY，内容为刚刚生成的私钥文件内容。名称也是任意，但是需要记住，等会需要用到。</p><p><img src="../static/images/3.png" alt="github secrets and variables"></p><p>在 site 仓库的 settings 面板中找到 Deploy Keys，然后添加一个 DEPLOY KEY，内容为刚刚生成的公钥文件内容，名称随意，建议取一个比较好记的名称。</p><p><img src="../static/images/2.png" alt="github deploy keys"></p><ol start="3"><li>使用刚刚添加的私钥进行身份验证</li></ol><p>在 Github Action 中通过 <code>${{secrets.REPO_SITE}}</code> 引用刚刚添加的密钥进行身份验证，<code>REPO_SITE</code> 为刚刚添加到 site 仓库的 key 名称。</p><pre><code>- name: Push to site
    uses: cpina/github-action-push-to-another-repository@main
    env:
      SSH_DEPLOY_KEY: ${{secrets.REPO_SITE}}
      ...
</code></pre><p>（完）</p></div><div class="markdown-footer"><span class="pre-article"><a href="/blogs/site/site-load-slowy">上一篇：网站加载慢，怎么解决?</a></span><span class="next-article"><a href="/blogs/developer-handbook/tmux">下一篇：tmux 极简使用</a></span></div></div><div class="footer">@2020-2023 Wang Pengfei</div></body></html>