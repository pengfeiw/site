<html lang="zh_cn"><head><title>const、constexpr 和常量表达式 | 王鹏飞</title><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="const,constexpr,常量表达式,const expression,c++"><meta name="description" content="理解 C++ 常量、常量表达式的概念"><link rel="stylesheet" href="/blogs/assests/code_github.css"><link rel="stylesheet" href="/blogs/assests/github_markdown.css"><link rel="stylesheet" href="/blogs/assests/article.css"><link rel="stylesheet" href="/blogs/assests/navigator.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous"><link rel="icon" href="/blogs/assests/images/icon.jpg"><meta property="author" content="王鹏飞"><script type="text/javascript">window.addEventListener("DOMContentLoaded",function(){document.getElementById("search-input").addEventListener("search",e=>{e.target.value&&window.open(`https://bing.com/search?q=${e.target.value}%20site%3A+pengfeixc.com`,"_blank")})})</script></head><body><div class="header"><div class="navigator"><div class="links"><div class="home"><a href="/blogs">Home</a></div><div class="email"><a href="mailto:pengfeixc@sina.com">Email</a></div><div class="github"><a target="_blank" href="https://github.com/pengfeiw">GitHub</a></div><div clss="minicode"><a target="_blank" href="https://pengfeiw.github.io/minicode">MiniCode</a></div><div class="search"><input id="search-input" type="search" placeholder="search"></div><div class="rss"><a href="/blogs/rss.xml"><img src="/blogs/assests/images/rss.svg" alt="rss"></a></div></div></div></div><div class="body"><div class="nothing"></div><div class="markdown"><div class="markdown-header"><span class="date">日期：2024年7月3日</span><span class="category"><a href="/blogs/clang">标签：C/C++</a></span></div><div class="markdown-body"><h1 id="const、constexpr">const、constexpr <a href="#const、constexpr">#</a></h1><p>先说结论：</p><ol><li><code>const</code> 修饰的变量表示该变量的值不会发生变化，但是不一定能够在编译期间就取得结果。<code>constexpr</code> 修饰的变量，不仅变量值不会发生变化，而且在编译期间就能取得结果。所以如果一个 const 变量能够在编译期间求值，那么它就是一个常量表达式。</li><li>constexpr 函数在编译期间求值，所以每次程序运行不会重复计算，使得程序运行更快。但是如果 contexpr 函数中存在无法在编译期间求值的参数，则 constexpr 函数和普通函数一样，此时函数的返回值不是常量表达式。</li></ol><h2 id="何为常量">何为常量 <a href="#何为常量">#</a></h2><p>常量（constant value），顾名思义就是变量值不会发生变化的变量。C++ 中可以通过 <code>const</code> 定义一个常量。</p><h2 id="何为常量表达式">何为常量表达式 <a href="#何为常量表达式">#</a></h2><p>满足以下条件的变量即为常量表达式：</p><ol><li>变量的值不会发生改变。</li><li>编译期间就能够取得结果。</li></ol><p>第一条表示变量是一个常量，所以常量表达式一定是一个常量，但是常量不一定是常量表达式。字面值一定是常量表达式。</p><pre><code class="hljs language-c++"><span class="hljs-type">int</span> a = <span class="hljs-number">4</span>; <span class="hljs-comment">// 不是常量表达式，因为 a 不是常量</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> b = a; <span class="hljs-comment">// 不是常量表达式，因为初始值 a 不是常量表达式</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> c = <span class="hljs-number">14</span>; <span class="hljs-comment">// 是常量表达式，因为 14 是字面值</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> d = c + <span class="hljs-number">1</span>; <span class="hljs-comment">// 是常量表达式，因为 c + 1 是常量表达式</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> e = <span class="hljs-built_in">getNumer</span>(); <span class="hljs-comment">// 如果 getNumer() 是普通函数，e 的值要在运行时才能确定，所以不是常量表达式</span>
</code></pre><p>常量表达式的使用场景：</p><ol><li>数组大小</li><li>整型模板实参（如 std::array&lt;T,N&gt; 的长度参数 N）</li><li>switch-case 中 case 标签</li><li>枚举量的值</li><li>对齐规格</li></ol><h2 id="constexpr 关键字">constexpr 关键字 <a href="#constexpr 关键字">#</a></h2><p>通过上面的例子可以看出，判断一个 const 对象是否为常量表达式时需要一定的思考过程，如果代码很复杂，判断难度会越来越高。所以 C++11 允许把变量声明为 constexpr 类型，利用编译器取保证变量为常量表达式，如果声明为 constexpr 的变量不满足常量表达式的条件，编译将会报错。所以当看到一个变量声明为 constexpr 时，那么它一定是常量表达式。</p><pre><code class="hljs language-c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> a = <span class="hljs-number">4</span>;
    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> b = <span class="hljs-built_in">getValue</span>(); <span class="hljs-comment">// error: function call must have a constant value in a constant expression</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre><h2 id="constexpr 函数">constexpr 函数 <a href="#constexpr 函数">#</a></h2><p>可以用 constexpr 声明常量表达式函数，它是指可以用作常量表达式的函数。但是要记住 constexpr 函数不一定返回常量表达式！需要满足：<strong>返回类型和所有形参的类型必须是字面值类型（literal type）。除了内置类型，用户自定义的类也可以是字面值类型，因为它的构造函数和成员函数也可以是 constexpr 函数</strong>。</p><p>只有 constexpr 函数的所有实参都是常量表达式，constexpr 函数的结果才是常量表达式。只要有一个参数值在编译期间未知，那就和普通函数一样，在运行时计算。</p><pre><code class="hljs language-c++"><span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> <span class="hljs-title">new_sz</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>; }
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> foo = <span class="hljs-built_in">new_sz</span>(); <span class="hljs-comment">// 正确：foo 是一个常量表达式</span>

<span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> <span class="hljs-title">sum</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> </span>{
  <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> i1 = <span class="hljs-number">42</span>;
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> i2 = <span class="hljs-built_in">sum</span>(i1, <span class="hljs-number">52</span>); <span class="hljs-comment">// 所有参数都是常量表达式，sum 的结果也是常量表达式，在编译期求值</span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">AddThree</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">sum</span>(i, <span class="hljs-number">3</span>); <span class="hljs-comment">// i 不是常量表达式，此时 sum 作为普通函数使用</span>
}
</code></pre><blockquote><p>为了能保证 constexpr 函数在编译时能随时展开计算，constexpr 函数隐式内联。内联函数和 constexpr 函数不同于其他函数，允许定义多次，但要保证所有的定义一致。正因如此，内联函数和 constexpr 函数一般定义在头文件中。</p></blockquote><h2 id="内联函数">内联函数 <a href="#内联函数">#</a></h2><p>简单提一下内联函数。可以通过 inline 关键字将函数声明为内联函数。例如：</p><pre><code class="hljs language-c++"><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">const</span> string&amp; <span class="hljs-title">shorterString</span><span class="hljs-params">(<span class="hljs-type">const</span> string &amp;s1, <span class="hljs-type">const</span> string &amp;s2)</span> </span>{
    <span class="hljs-keyword">return</span> s1.<span class="hljs-built_in">size</span>() &lt;= s2.<span class="hljs-built_in">size</span>() ? s1 : s2;
}

cout &lt;&lt; <span class="hljs-built_in">shorterString</span>(s1, s2) &lt;&lt; endl;
</code></pre><p>在编译过程中 <code>cout &lt;&lt; shorterString(s1, s2) &lt;&lt; endl;</code> 将会被展开成为以下形式：</p><pre><code class="hljs language-c++">cout &lt;&lt; (s1.<span class="hljs-built_in">size</span>() &lt;= s2.<span class="hljs-built_in">size</span>() ? s1 : s2) &lt;&lt; endl;
</code></pre><p>这样可以消除 shorterString 运行时的开销。</p><blockquote><p>inline 关键字只是向编译器发出一个请求，编译器可以选择忽略这个请求，将函数当作普通函数对待。</p></blockquote><p>（完）</p></div><div class="markdown-footer"><span class="pre-article"><a href="/blogs/algorithm-math/hermite-curves">上一篇：埃尔米特曲线</a></span><span class="next-article"><a href="/blogs/developer-handbook/vsvim">下一篇：VsVim</a></span></div></div><div class="toc"><div class="toc-header">目录</div><div class="toc-body"><div class="toc-item"><a class="toc-item-link" href="#const、constexpr" style="padding-left:15px">const、constexpr</a></div><div class="toc-item"><a class="toc-item-link" href="#何为常量" style="padding-left:30px">何为常量</a></div><div class="toc-item"><a class="toc-item-link" href="#何为常量表达式" style="padding-left:30px">何为常量表达式</a></div><div class="toc-item"><a class="toc-item-link" href="#constexpr 关键字" style="padding-left:30px">constexpr 关键字</a></div><div class="toc-item"><a class="toc-item-link" href="#constexpr 函数" style="padding-left:30px">constexpr 函数</a></div><div class="toc-item"><a class="toc-item-link" href="#内联函数" style="padding-left:30px">内联函数</a></div></div></div></div></body></html>